name: Notify In Progress Items

on:
  schedule:
    - cron: '0 9 * * 1' # Executa toda segunda-feira Ã s 9:00 UTC
  workflow_dispatch: # Permite disparo manual

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Get Project Items via GraphQL
      uses: octokit/graphql-action@v2.x
      id: list_projects
      with:
        query: |
          query {
            viewer {
              projectsV2(first: 10) {
                nodes {
                  number
                  title
                }
              }
            }
          }
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - run: "echo 'Projects: ${{ steps.list_projects.outputs.data }}'"
      # id: get_items
      # with:
      #   query: |
      #     query {
      #       viewer {
      #         projectV2(number: 4) {
      #           items(first: 100) {
      #             nodes {
      #               id
      #               content {
      #                 __typename
      #                 ... on Issue {
      #                   url
      #                   title
      #                 }
      #                 ... on PullRequest {
      #                   url
      #                   title
      #                 }
      #               }
      #               fieldValues(first: 10) {
      #                 nodes {
      #                   ... on ProjectV2ItemFieldSingleSelectValue {
      #                     name
      #                     id
      #                   }
      #                 }
      #               }
      #             }
      #           }
      #         }
      #       }
      #     }
      # env:
      #   GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Filter and Send Notification via IFTTT
      run: |
        ITEMS=$(echo "${{ steps.get_items.outputs.data }}" | jq -r '.data.viewer.projectV2.items.nodes[] | select(.fieldValues.nodes[].id == "PVTFSV_lQHOAk5qjM4AyQWPzgXWvN3OERSYcw") | .content.url' | paste -sd ",")
        if [ -n "$ITEMS" ]; then
          curl -X POST -H "Content-Type: application/json" \
            -d "{\"value1\":\"In Progress Items\", \"value2\":\"$ITEMS\"}" \
            https://maker.ifttt.com/trigger/notification_github/with/key/lg7s5PhDS4NWUXwbcdSAMoLyDchR0mstR_sIv2dkk-B
        else
          echo "No items in 'In Progress' column."
        fi
